{% extends "base.html" %}
{% block content %}

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
    :root {
        --brand-primary: #4e73df;
        --brand-success: #1cc88a;
        --soft-bg: #f8f9fc;
    }

    body {
        background-color: var(--soft-bg);
        font-family: 'Inter', sans-serif;
    }

    /* Live Feed Styling */
    .feed-container {
        background: #000;
        border-radius: 20px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .live-indicator {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(231, 74, 59, 0.9);
        color: white;
        padding: 4px 12px;
        border-radius: 50px;
        font-size: 0.7rem;
        font-weight: 800;
        animation: pulse 2s infinite;
    }

    /* COMPACT SLOT DESIGN */
    .slot-card {
        border: none;
        border-radius: 20px;
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .slot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, 48px);
        gap: 8px;
        justify-content: center;
    }

    .slot-btn {
        height: 48px;
        width: 100%;
        border: 2px solid #1cc88a;
        border-radius: 8px;
        background: transparent;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--brand-success);
        padding: 2px;
    }

    .slot-btn i {
        font-size: 0.8rem !important;
        margin-bottom: 1px !important;
    }

    .slot-btn span {
        font-size: 0.55rem !important;
        line-height: 1;
        font-weight: 700;
    }

    .slot-btn.full {
        border-color: #e74a3b;
        color: #e74a3b;
        background-color: rgba(231, 74, 59, 0.1);
        cursor: not-allowed;
    }

    .slot-btn.reserved {
        border-color: #f6c23e;
        color: #f6c23e;
        background-color: rgba(246, 194, 62, 0.1);
    }

    .slot-btn:hover:not(:disabled) {
        background-color: rgba(28, 200, 138, 0.05);
        transform: translateY(-2px);
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        100% {
            opacity: 1;
        }
    }

    /* Legend Styling */
    .status-legend {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 15px;
        font-size: 0.8rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .dot-green {
        background: #1cc88a;
    }

    .dot-red {
        background: #e74a3b;
    }

    .dot-yellow {
        background: #f6c23e;
    }

    /* ... rest of styles ... */

    /* --- SECURE PAYMENT MODAL STYLES --- */
    #paymentMethodModal .modal-content {
        background-color: #f3f4f6;
        position: relative;
    }

    #paymentMethodModal .payment-card {
        background: white;
        width: 100%;
        border-radius: 0;
        box-shadow: none;
        padding: 2rem;
    }

    /* Overlays */
    .payment-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 100;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 2rem;
    }

    .payment-overlay.active {
        display: flex;
    }

    /* Checkmark Animation */
    .checkmark-container {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
    }

    .checkmark {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: block;
        stroke-width: 2;
        stroke: #1cc88a;
        stroke-miterlimit: 10;
        box-shadow: inset 0px 0px 0px #1cc88a;
        animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
    }

    .checkmark__circle {
        stroke-dasharray: 166;
        stroke-dashoffset: 166;
        stroke-width: 2;
        stroke-miterlimit: 10;
        stroke: #1cc88a;
        fill: none;
        animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }

    .checkmark__check {
        transform-origin: 50% 50%;
        stroke-dasharray: 48;
        stroke-dashoffset: 48;
        animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }

    @keyframes stroke {
        100% {
            stroke-dashoffset: 0;
        }
    }

    @keyframes scale {

        0%,
        100% {
            transform: none;
        }

        50% {
            transform: scale3d(1.1, 1.1, 1);
        }
    }

    @keyframes fill {
        100% {
            box-shadow: inset 0px 0px 0px 40px #1cc88a;
        }
    }

    #paymentMethodModal .header {
        text-align: center;
        margin-bottom: 1.5rem;
    }

    #paymentMethodModal .header h2 {
        margin: 0;
        font-size: 1.25rem;
        color: #1f2937;
        font-weight: 700;
    }

    #paymentMethodModal .amount {
        font-size: 1.75rem;
        font-weight: 800;
        color: #000;
        margin: 10px 0;
    }

    /* Tabs */
    #paymentMethodModal .tabs {
        display: flex;
        background: #e5e7eb;
        padding: 4px;
        border-radius: 12px;
        margin-bottom: 20px;
    }

    #paymentMethodModal .tab {
        flex: 1;
        padding: 10px;
        border: none;
        cursor: pointer;
        border-radius: 8px;
        font-weight: 600;
        color: #6b7280;
        background: transparent;
        transition: 0.2s;
    }

    #paymentMethodModal .tab.active {
        background: white;
        color: #2563eb;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* Forms */
    #paymentMethodModal label {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 6px;
        color: #4b5563;
        text-align: left;
    }

    #paymentMethodModal input {
        width: 100%;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 1rem;
        box-sizing: border-box;
        display: block;
    }

    #paymentMethodModal input:focus {
        outline: 2px solid #93c5fd;
        border-color: #2563eb;
    }

    /* Logos - Strict Sizing */
    #paymentMethodModal .logo-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #f3f4f6;
    }

    #paymentMethodModal .logo-row img {
        height: 25px !important;
        width: auto !important;
        max-width: 80px !important;
        filter: grayscale(100%);
        opacity: 0.6;
        transition: 0.3s;
        object-fit: contain;
    }

    #paymentMethodModal .logo-row img:hover {
        filter: grayscale(0%);
        opacity: 1;
    }

    /* Captcha & QR */
    #paymentMethodModal .captcha-box {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f9fafb;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        margin-bottom: 15px;
    }

    #paymentMethodModal #captcha-code {
        font-weight: 800;
        letter-spacing: 4px;
        font-style: italic;
        background: #e5e7eb;
        padding: 5px 15px;
        border-radius: 4px;
        user-select: none;
        color: #374151;
    }

    #paymentMethodModal #qr-container {
        text-align: center;
        display: none;
        padding: 10px;
    }

    #paymentMethodModal #qr-container img {
        width: 180px;
        height: 180px;
        margin: 10px auto;
        border: 4px solid #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: block;
    }

    /* Buttons */
    #paymentMethodModal .btn-pay {
        width: 100%;
        background: #2563eb;
        color: white;
        border: none;
        padding: 15px;
        border-radius: 10px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.2s;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
    }

    #paymentMethodModal .btn-pay:hover {
        background: #1e40af;
        transform: translateY(-1px);
    }

    #paymentMethodModal .btn-qr {
        width: 100%;
        background: #10b981;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 10px;
        font-weight: 600;
        margin-top: 10px;
        cursor: pointer;
    }

    #paymentMethodModal .footer {
        margin-top: 20px;
        font-size: 0.75rem;
        color: #9ca3af;
        text-align: center;
    }

    #paymentMethodModal .hidden {
        display: none !important;
    }



    /* ... (rest of CSS unchanged until we reach HTML) ... */
</style>

<div class="container py-4">
    <div class="row mb-4 align-items-center text-center">
        <div class="col-12">
            <h2 class="fw-bold text-dark mb-1">{{ lot.name }}</h2>
            <div class="mb-2">
                <span class="text-warning fw-bold"><i class="fas fa-star"></i> {{ avg_rating }}</span>
                <span class="text-muted small">({{ reviews|length }} reviews)</span>
            </div>
            <p class="text-muted small">
                Rate: <span class="badge bg-success">â‚¹{{ lot.hourly_rate }}/hr</span>
                {% if lot.latitude and lot.longitude %}
                <a href="https://www.google.com/maps/search/?api=1&query={{ lot.latitude }},{{ lot.longitude }}"
                    target="_blank" class="btn btn-sm btn-outline-primary ms-2 rounded-pill">
                    <i class="fas fa-location-arrow me-1"></i> View on Map
                </a>
                {% endif %}
            </p>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="feed-container">
                <div class="live-indicator"><i class="fas fa-circle me-1"></i> LIVE AI FEED</div>
                <img src="{{ url_for('video_feed', lot_id=lot.id) }}" class="w-100"
                    style="height: auto; display: block;">
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card slot-card h-100">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3 text-center">Select Slot</h5>

                    <div class="status-legend">
                        <div class="legend-item">
                            <div class="dot dot-green"></div> Avail
                        </div>
                        <div class="legend-item">
                            <div class="dot dot-yellow"></div> Pre-order
                        </div>
                        <div class="legend-item">
                            <div class="dot dot-red"></div> Full
                        </div>
                    </div>

                    <div class="slot-grid" id="slotContainer">
                        {% for slot in slots %}
                        {% set status = slot_status.get(slot.id, 'available') %}
                        {% if status == 'full' %}
                        <button class="slot-btn full" disabled>
                            <i class="fas fa-car mb-1" style="font-size: 0.8rem;"></i>
                            <span class="fw-bold" style="font-size: 0.75rem;">{{ slot.slot_label }}</span>
                        </button>
                        {% elif status == 'reserved' %}
                        <button onclick="openBookingModal('{{ slot.id }}', '{{ slot.slot_label }}')"
                            class="slot-btn reserved" id="btn-{{ slot.id }}">
                            <i class="fas fa-clock mb-1" style="font-size: 0.8rem;"></i>
                            <span class="fw-bold" style="font-size: 0.75rem;">{{ slot.slot_label }}</span>
                        </button>
                        {% else %}
                        <button onclick="openBookingModal('{{ slot.id }}', '{{ slot.slot_label }}')" class="slot-btn"
                            id="btn-{{ slot.id }}">
                            <i class="fas fa-parking mb-1" style="font-size: 0.8rem;"></i>
                            <span class="fw-bold" style="font-size: 0.75rem;">{{ slot.slot_label }}</span>
                        </button>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h4 class="fw-bold mb-4">Customer Reviews</h4>
            {% if not reviews %}
            <p class="text-muted">No reviews yet. Be the first to rate!</p>
            {% else %}
            <div class="row g-3">
                {% for r in reviews %}
                <div class="col-md-6 col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <h6 class="fw-bold mb-0">{{ r.user.name }}</h6>
                                <span class="text-warning small">
                                    {% for i in range(r.rating) %}<i class="fas fa-star"></i>{% endfor %}
                                    {% for i in range(5 - r.rating) %}<i class="far fa-star"></i>{% endfor %}
                                </span>
                            </div>
                            <p class="text-muted small mb-2">{{ r.comment }}</p>
                            <small class="text-muted opacity-50" style="font-size: 0.75rem;">{{
                                r.created_at.strftime('%d %b %Y') }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">ðŸ“… Booking Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="bookingForm">
                    <input type="hidden" id="modalSlotId">

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">FULL NAME</label>
                        <input type="text" id="name" class="form-control bg-light border-0" placeholder="John Doe"
                            required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">PHONE NUMBER</label>
                        <div class="input-group">
                            <span class="input-group-text border-0 bg-light text-muted">+91</span>
                            <input type="tel" id="phone" class="form-control bg-light border-0" placeholder="9876543210"
                                required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">VEHICLE NUMBER</label>
                        <input type="text" id="vehicle" class="form-control bg-light border-0 text-uppercase"
                            placeholder="TN-01-AB-1234" required>
                    </div>

                    <div class="row g-2 mb-4">
                        <div class="col-7">
                            <label class="form-label small fw-bold text-muted">START TIME</label>
                            <input type="datetime-local" id="start_time" class="form-control bg-light border-0 small"
                                required>
                        </div>
                        <div class="col-5">
                            <label class="form-label small fw-bold text-muted">DURATION</label>
                            <select id="duration" class="form-select bg-light border-0 small" onchange="updateTotal()">
                                <option value="1">1 Hour</option>
                                <option value="2">2 Hours</option>
                                <option value="3">3 Hours</option>
                                <option value="4">4 Hours</option>
                                <option value="5">5 Hours</option>
                            </select>
                        </div>
                    </div>

                    <div
                        class="p-3 rounded-4 bg-primary bg-opacity-10 d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-primary">Payable Amount</span>
                        <span class="h4 mb-0 fw-bold text-primary" id="totalDisplay">â‚¹{{ lot.hourly_rate }}</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 px-4 pb-4">
                <button type="button" class="btn btn-primary w-100 py-3 fw-bold rounded-pill"
                    onclick="goToPaymentSelection()">
                    Proceed to Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SECURE PAYMENT MODAL (Merged from sample.html) -->
<div class="modal fade" id="paymentMethodModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 overflow-hidden">
            <!-- Processing Overlay -->
            <div id="processingOverlay" class="payment-overlay">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="fw-bold">Processing Payment</h4>
                <p class="text-muted">Please wait while we verify your transaction...</p>
            </div>

            <!-- Success Overlay -->
            <div id="successOverlay" class="payment-overlay">
                <div class="checkmark-container">
                    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
                        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
                    </svg>
                </div>
                <h3 class="fw-bold text-success">Payment Done!</h3>
                <p class="text-muted">Your booking has been confirmed.</p>
            </div>
            <!-- Modal Body with Custom Payment Card Style -->
            <div class="modal-body p-0">
                <div class="payment-card border-0 shadow-none">
                    <div class="header position-relative">
                        <button type="button" class="btn-close position-absolute top-0 end-0"
                            data-bs-dismiss="modal"></button>
                        <h2>Secure Payment</h2>
                        <div class="amount" id="secureTotalDisplay">â‚¹0.00</div>
                    </div>

                    <div class="tabs">
                        <button class="tab active" id="card-tab" onclick="toggleTab('card')">Card</button>
                        <button class="tab" id="upi-tab" onclick="toggleTab('upi')">UPI / QR</button>
                    </div>

                    <!-- CARD SECTION -->
                    <div id="card-section">
                        <div class="logo-row">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg"
                                alt="Visa">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg"
                                alt="Mastercard">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="Paypal">
                        </div>
                        <form onsubmit="event.preventDefault(); processSecurePay('Card');">
                            <label>Cardholder Name</label>
                            <input type="text" id="cardName" placeholder="John Doe" required>

                            <label>Card Number</label>
                            <input type="text" id="card-num" placeholder="0000 0000 0000 0000" maxlength="19" required>

                            <div style="display:flex; gap:10px;">
                                <div style="flex:1">
                                    <label>Expiry</label>
                                    <input type="text" placeholder="MM/YY" maxlength="5" required>
                                </div>
                                <div style="flex:1">
                                    <label>CVV</label>
                                    <input type="password" placeholder="***" maxlength="3" required>
                                </div>
                            </div>
                            <!-- Helper buttons for Demo purposes -->
                            <button type="submit" class="btn-pay">Pay Securely</button>
                        </form>
                    </div>

                    <!-- UPI SECTION -->
                    <div id="upi-section" class="hidden">
                        <div class="logo-row">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_Pay_Logo.svg"
                                alt="GPay">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo.png" alt="UPI"
                                style="height:15px">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/7/71/PhonePe_Logo.svg"
                                alt="PhonePe">
                        </div>

                        <div id="upi-input-group">
                            <form onsubmit="event.preventDefault(); verifyAndPayUpi();">
                                <label>Enter UPI ID</label>
                                <input type="text" id="vpa" placeholder="user@bank" required>

                                <label>Security Verification</label>
                                <div class="captcha-box">
                                    <span id="captcha-code">A1B23</span>
                                    <button type="button" onclick="newCaptcha()"
                                        style="background:none; border:none; color:blue; cursor:pointer; font-size:0.7rem;">Refresh</button>
                                </div>
                                <input type="text" id="captcha-input" placeholder="Enter characters above" required>

                                <button type="submit" class="btn-pay">Verify & Pay</button>
                                <button type="button" class="btn-qr" onclick="genQR()">Generate QR Code</button>
                            </form>
                        </div>

                        <div id="qr-container">
                            <p style="font-size:0.85rem; color:#6b7280;">Scan this QR with any UPI App</p>
                            <img id="qr-img" src="" alt="QR">
                            <p style="color:red; font-size:0.8rem; font-weight:bold;">Expiring in: <span
                                    id="timer">05:00</span></p>
                            <button class="btn-pay" style="background:#1cc88a; margin-bottom: 10px;"
                                onclick="paymentDone()">Payment Done</button>
                            <button class="btn-pay" style="background:#6b7280;" onclick="cancelQR()">Back</button>
                        </div>
                    </div>

                    <div class="footer">
                        ðŸ”’ SSL Encrypted â€¢ PCI-DSS Compliant â€¢ Secure 256-bit
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4 border-0 rounded-4">
            <div class="modal-body">
                <div class="mb-3 text-success">
                    <i class="fas fa-check-circle fa-4x"></i>
                </div>
                <h4 class="fw-bold mb-3">Booking Confirmed!</h4>
                <p class="text-muted mb-4">Here is your entry ticket.</p>

                <img id="successQrImage" src="" alt="Ticket QR" class="img-fluid border p-2 rounded mb-3"
                    style="width: 200px;">

                <div class="alert alert-light border p-2 mb-4 d-inline-block">
                    <small class="text-muted d-block fw-bold" style="font-size:0.7rem;">SECURE TICKET ID</small>
                    <code id="displayUuid" class="fw-bold text-dark user-select-all" style="font-size:0.9rem;">--</code>
                    <br>
                    <small class="text-muted" style="font-size:0.65rem;">(Use this code at the gate scanner)</small>
                </div>

                <a href="/customer/dashboard" class="btn btn-primary w-100 rounded-pill py-2 mb-2">Go to My Bookings</a>
                <button onclick="downloadReceipt()" class="btn btn-outline-dark w-100 rounded-pill py-2">
                    <i class="fas fa-download me-2"></i> Download Receipt
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const hourlyRate = {{ lot.hourly_rate }};
    const razorpayKey = "{{ rzp_key }}";
    let bookingModal, paymentModal;

    document.addEventListener("DOMContentLoaded", function () {
        bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        paymentModal = new bootstrap.Modal(document.getElementById('paymentMethodModal'));

        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('start_time').value = now.toISOString().slice(0, 16);

        // Start Live Status Polling
        setInterval(refreshSlotStatus, 2000); // Check every 2 seconds

        // Input Formatting for Card
        const cardNumInput = document.getElementById('card-num');
        if (cardNumInput) {
            cardNumInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^\d]/g, '').replace(/(.{4})/g, '$1 ').trim();
            });
        }
    });

    function refreshSlotStatus() {
        fetch('/api/live_status/{{ lot.id }}')
            .then(res => res.json())
            .then(data => {
                // data = { "1": "full", "2": "available" ... }
                for (const [slotId, status] of Object.entries(data)) {
                    const btn = document.getElementById('btn-' + slotId);
                    if (!btn) continue; // Might be rendered as disabled full button differently

                    // If button is already disabled/full by server render, we might need a way to reference it
                    // But here we mainly care about updating "available" buttons to "full" if car is detected

                    if (status === 'full') {
                        // Mark as Occupied (Red)
                        btn.className = "slot-btn full";
                        btn.disabled = true;
                        btn.innerHTML = `
                            <i class="fas fa-car mb-1" style="font-size: 0.8rem;"></i>
                            <span class="fw-bold" style="font-size: 0.75rem;">${btn.innerText.trim()}</span>
                        `;
                    } else if (status === 'available') {
                        // Mark as Open (Green) - Only if it wasn't pre-booked (logic simplified for visual sync)
                        if (btn.classList.contains('full')) {
                            // If it WAS full but now free
                            btn.className = "slot-btn";
                            btn.disabled = false;
                            btn.innerHTML = `
                                <i class="fas fa-parking mb-1" style="font-size: 0.8rem;"></i>
                                <span class="fw-bold" style="font-size: 0.75rem;">${btn.innerText.trim()}</span>
                            `;
                        }
                    }
                }
            })
            .catch(err => console.error("Polling Error:", err));
    }

    function openBookingModal(id, label) {
        document.getElementById('modalSlotId').value = id;
        bookingModal.show();
    }

    function updateTotal() {
        const duration = document.getElementById('duration').value;
        const total = (hourlyRate * duration).toFixed(2);
        document.getElementById('totalDisplay').innerText = "â‚¹" + total;
        document.getElementById('secureTotalDisplay').innerText = "â‚¹" + total;
        return total;
    }

    function goToPaymentSelection() {
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        const vehicle = document.getElementById('vehicle').value;

        if (!name || !phone || !vehicle) {
            alert("Please provide Name, Phone, and Vehicle Number.");
            return;
        }
        bookingModal.hide();
        updateTotal(); // Ensure total is synced
        paymentModal.show();
    }

    // --- SECURE PAYMENT LOGIC ---

    function toggleTab(type) {
        document.getElementById('card-section').classList.toggle('hidden', type !== 'card');
        document.getElementById('upi-section').classList.toggle('hidden', type !== 'upi');
        document.getElementById('card-tab').classList.toggle('active', type === 'card');
        document.getElementById('upi-tab').classList.toggle('active', type === 'upi');
        if (type === 'upi') newCaptcha();
    }

    function newCaptcha() {
        const code = Math.random().toString(36).substring(2, 7).toUpperCase();
        document.getElementById('captcha-code').innerText = code;
    }

    // CARD PAYMENT
    async function processSecurePay(method) {
        const btn = document.querySelector('#card-section .btn-pay');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        btn.disabled = true;

        // Show processing overlay
        document.getElementById('processingOverlay').classList.add('active');

        await new Promise(r => setTimeout(r, 2000)); // Simulate Bank Delay

        // Success Flow
        confirmBookingOnServer("pay_secure_card_" + new Date().getTime(), btn, originalText);
    }

    // UPI PAYMENT
    async function verifyAndPayUpi() {
        const entered = document.getElementById('captcha-input').value;
        const actual = document.getElementById('captcha-code').innerText;

        if (entered !== actual) {
            alert("Incorrect Captcha! Please try again.");
            return;
        }

        const btn = document.querySelector('#upi-input-group .btn-pay');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verifying VPA...';
        btn.disabled = true;

        // Show processing overlay
        document.getElementById('processingOverlay').classList.add('active');

        await new Promise(r => setTimeout(r, 1500)); // Simulate API Verify

        // Success Flow
        confirmBookingOnServer("pay_secure_upi_" + new Date().getTime(), btn, originalText);
    }

    // QR GENERATION
    function genQR() {
        const upiId = "{{ lot.upi_id or 'merchant@upi' }}";
        const amount = updateTotal();
        const upiLink = `upi://pay?pa=${upiId}&pn=SmartPark&am=${amount}&cu=INR`;

        document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(upiLink)}`;
        document.getElementById('upi-input-group').style.display = 'none';
        document.getElementById('qr-container').style.display = 'block';

        startTimer();
    }

    let qrTimerInterval;

    function cancelQR() {
        if (qrTimerInterval) clearInterval(qrTimerInterval);
        document.getElementById('upi-input-group').style.display = 'block';
        document.getElementById('qr-container').style.display = 'none';
    }

    function paymentDone() {
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        btn.disabled = true;

        // Show processing overlay
        document.getElementById('processingOverlay').classList.add('active');

        if (qrTimerInterval) clearInterval(qrTimerInterval);
        confirmBookingOnServer("pay_secure_qr_manual_" + new Date().getTime(), btn, originalText);
    }

    function startTimer() {
        let sec = 300; // 5 Minutes
        const timerElem = document.getElementById('timer');

        if (qrTimerInterval) clearInterval(qrTimerInterval);

        qrTimerInterval = setInterval(() => {
            sec--;
            let min = Math.floor(sec / 60);
            let s = sec % 60;
            timerElem.innerText = `${min}:${s < 10 ? '0' + s : s}`;



            if (sec === 0) clearInterval(qrTimerInterval);
        }, 1000);
    }

    function confirmBookingOnServer(paymentId, loaderElement = null, originalContent = null) {
        const data = {
            slot_id: document.getElementById('modalSlotId').value,
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            vehicle: document.getElementById('vehicle').value,
            start_time: document.getElementById('start_time').value,
            duration: document.getElementById('duration').value,
            payment_id: paymentId
        };

        fetch('/book_slot_confirm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(async data => {
                if (data.status === 'success') {
                    // Hide processing, show success animation
                    document.getElementById('processingOverlay').classList.remove('active');
                    document.getElementById('successOverlay').classList.add('active');

                    // Wait for animation to finish
                    await new Promise(r => setTimeout(r, 2000));

                    // Hide payment modal
                    if (paymentModal) paymentModal.hide();

                    // Cleanup overlays for next time
                    document.getElementById('successOverlay').classList.remove('active');

                    // Show Ticket Modal
                    document.getElementById('successQrImage').src = '/get_qr/' + data.booking_id;
                    document.getElementById('displayUuid').innerText = data.ticket_uuid || ('#' + data.booking_id);

                    var successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                } else {
                    // Hide overlay and reset button if error
                    document.getElementById('processingOverlay').classList.remove('active');
                    if (loaderElement) {
                        loaderElement.innerHTML = originalContent;
                        loaderElement.disabled = false;
                    }
                    alert(data.message);
                }
            })
            .catch(err => {
                console.error(err);
                document.getElementById('processingOverlay').classList.remove('active');
                if (loaderElement) {
                    loaderElement.innerHTML = originalContent;
                    loaderElement.disabled = false;
                }
                alert("Something went wrong: " + err);
            });
    }

    function downloadReceipt() {
        // Just download the QR image for simplicity since it's the main ticket
        const qrSrc = document.getElementById('successQrImage').src;
        const link = document.createElement('a');
        link.href = qrSrc;
        link.download = 'SmartPark_Ticket.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
{% endblock %}