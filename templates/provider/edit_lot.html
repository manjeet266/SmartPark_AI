{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    :root {
        --brand-primary: #4e73df;
        --brand-dark: #1a1c23;
        --soft-bg: #f4f7f6;
    }

    .edit-wrapper {
        min-height: 80vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--soft-bg);
        font-family: 'Inter', sans-serif;
        padding: 20px 0;
    }

    .edit-card {
        width: 100%;
        max-width: 380px;
        /* Original Compact Width */
        background: white;
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    .card-header-visual {
        background: var(--brand-dark);
        color: white;
        padding: 1.25rem 1rem;
        text-align: center;
        border-bottom: 3px solid #f6c23e;
    }

    .brand-icon {
        width: 40px;
        height: 40px;
        background: #f6c23e;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        font-size: 1rem;
        color: var(--brand-dark);
    }

    .form-label {
        font-weight: 700;
        color: #4a5568;
        font-size: 0.65rem;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        margin-bottom: 0.25rem;
    }

    .form-control {
        border: 1.5px solid #edf2f7;
        padding: 0.6rem 0.8rem;
        border-radius: 8px;
        background-color: #f8fafc;
        font-size: 0.9rem;
    }

    .input-group-text {
        background-color: #f8fafc;
        border: 1.5px solid #edf2f7;
        color: #a0aec0;
        padding: 0 0.75rem;
    }

    .btn-save {
        background: #1cc88a;
        color: white;
        border: none;
        padding: 0.75rem;
        border-radius: 8px;
        font-weight: 700;
        width: 100%;
        transition: 0.3s;
        font-size: 0.85rem;
    }

    .btn-save:hover {
        background: #17a673;
        transform: translateY(-1px);
    }

    .info-note {
        background-color: #f0f4ff;
        border-left: 3px solid var(--brand-primary);
        padding: 0.75rem;
        border-radius: 6px;
        font-size: 0.7rem;
        color: #4e5e7a;
        line-height: 1.3;
    }

    .card-body {
        padding: 1.5rem !important;
    }

    /* Map Container */
    #map {
        height: 250px;
        border-radius: 8px;
        z-index: 1;
        margin-top: 10px;
        border: 1px solid #edf2f7;
    }
</style>

<div class="edit-wrapper">
    <div class="edit-card shadow-lg">
        <div class="card-header-visual">
            <div class="brand-icon">
                <i class="fas fa-edit"></i>
            </div>
            <h5 class="fw-bold mb-0">Modify Lot</h5>
        </div>

        <div class="card-body">
            <form action="/provider/edit_lot/{{ lot.id }}" method="POST">

                <div class="mb-3">
                    <label class="form-label">Lot Name</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-tag"></i></span>
                        <input type="text" name="name" class="form-control" value="{{ lot.name }}" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Location</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                        <input type="text" name="location" class="form-control" value="{{ lot.location }}"
                            id="addressInput" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label mb-2">Update Map Location</label>

                    <div class="input-group mb-2">
                        <input type="text" id="mapSearchInput" class="form-control" placeholder="Search area...">
                        <button type="button" id="searchLocationBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-search"></i>
                        </button>
                        <button type="button" id="getLocationBtn" class="btn btn-outline-primary">
                            <i class="fas fa-location-arrow"></i> My Location
                        </button>
                    </div>

                    <div id="map"></div>

                    <small id="status-msg" class="text-muted d-block mt-1" style="font-size: 0.7rem;">
                        <i class="fas fa-info-circle small me-1"></i>Search is best for PC/Laptop accuracy.
                    </small>

                    <input type="hidden" name="latitude" id="latInput" value="{{ lot.latitude or '' }}">
                    <input type="hidden" name="longitude" id="lngInput" value="{{ lot.longitude or '' }}">
                </div>

                <div class="mb-3">
                    <label class="form-label">UPI ID</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-money-bill-wave"></i></span>
                        <input type="text" name="upi_id" class="form-control" value="{{ lot.upi_id or '' }}"
                            placeholder="merchant@upi" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Hourly Rate</label>
                    <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input type="number" step="0.5" name="hourly_rate" class="form-control"
                            value="{{ lot.hourly_rate }}" required>
                    </div>
                </div>

                <div class="info-note mb-3">
                    <i class="fas fa-info-circle me-1 text-primary"></i>
                    To update <strong>Video/Images</strong>, please delete and recreate this lot.
                </div>

                <button type="submit" class="btn btn-save mb-2">
                    Save Changes
                </button>

                <div class="text-center">
                    <a href="/provider/dashboard" class="text-muted small text-decoration-none">
                        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Initialization ---
        var savedLat = {{ lot.latitude | tojson if lot.latitude is not none else 'null'
    }};
    var savedLng = {{ lot.longitude | tojson if lot.longitude is not none else 'null' }};

    // Initialize map
    // Default to saved location if available, otherwise generic world view
    var initialLat = savedLat !== null ? savedLat : 20;
    var initialLng = savedLng !== null ? savedLng : 0;
    var zoomLevel = savedLat !== null ? 16 : 2;

    var map = L.map('map').setView([initialLat, initialLng], zoomLevel);
    var marker;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // --- Core Functions ---

    function updateUI(lat, lon) {
        // Update hidden inputs
        document.getElementById('latInput').value = lat;
        document.getElementById('lngInput').value = lon;

        // Fetch and update address text input
        getAddress(lat, lon);
    }

    function setMapMarker(lat, lon) {
        if (marker) {
            marker.setLatLng([lat, lon]);
        } else {
            marker = L.marker([lat, lon], { draggable: true }).addTo(map);
            marker.on('dragend', function (event) {
                var position = event.target.getLatLng();
                updateUI(position.lat, position.lng);
            });
        }
        map.setView([lat, lon], 16);
    }

    function getAddress(lat, lon) {
        // Use ID selector if available, or fallback to name
        const locationInput = document.getElementById('addressInput') || document.querySelector('input[name="location"]');
        locationInput.style.opacity = '0.6';

        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&lat=${lat}&lon=${lon}`)
            .then(response => response.json())
            .then(data => {
                const addr = data.address || {};

                const components = [];
                if (addr.house_number) components.push(addr.house_number);
                if (addr.road) components.push(addr.road);
                if (addr.suburb) components.push(addr.suburb);
                else if (addr.village) components.push(addr.village);

                if (addr.city) components.push(addr.city);
                else if (addr.town) components.push(addr.town);
                else if (addr.county) components.push(addr.county);

                if (addr.state) components.push(addr.state);
                if (addr.postcode) components.push(addr.postcode);
                if (addr.country) components.push(addr.country);

                const fullAddress = components.filter(c => c).join(', ');
                locationInput.value = fullAddress || data.display_name || "Address not found";
            })
            .catch((err) => {
                console.error("Address fetch error:", err);
                locationInput.value = "Unable to fetch address";
            })
            .finally(() => {
                locationInput.style.opacity = '1';
            });
    }

    // --- Logic Execution ---

    // If we have saved coordinates, show them immediately
    if (savedLat !== null && savedLng !== null) {
        setMapMarker(savedLat, savedLng);
        // Optional: We could fetch address for saved coords if input is empty, 
        // but usually it's already saved in database.
    }


    // --- Event Listeners ---

    // 1. Get Live Location
    document.getElementById('getLocationBtn').addEventListener('click', function () {
        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser");
            return;
        }

        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                updateUI(lat, lon);
                setMapMarker(lat, lon);

                btn.innerHTML = '<i class="fas fa-check"></i> Found';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            },
            () => {
                alert("Unable to retrieve your location");
                btn.innerHTML = originalText;
            },
            { enableHighAccuracy: true }
        );
    });

    // 2. Map Clik
    map.on("click", function (e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;

        updateUI(lat, lon);
        setMapMarker(lat, lon);
    });

    // 3. Search
    async function searchLocation(query) {
        if (!query) return;
        const searchBtn = document.getElementById('searchLocationBtn');
        const originalContent = searchBtn.innerHTML;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
            const data = await response.json();
            if (data && data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                updateUI(lat, lon);
                setMapMarker(lat, lon);
            } else {
                alert('Location not found.');
            }
        } catch (e) {
            console.error(e);
            alert('Search failed.');
        } finally {
            searchBtn.innerHTML = originalContent;
        }
    }

    document.getElementById('searchLocationBtn').addEventListener('click', function () {
        searchLocation(document.getElementById('mapSearchInput').value);
    });

    document.getElementById('mapSearchInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchLocation(this.value);
        }
    });

    // Render fix
    setTimeout(function () { map.invalidateSize(); }, 500);
                    });
</script>

{% endblock %}